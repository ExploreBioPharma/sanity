addon:
  chrome: stable
language: node_js
os: osx
node_js:
  - '6'
  - '8'
cache: yarn
before_script:
  - yarn
  - travis_wait 30 yarn run bootstrap
  - yarn run build
  # Build CLI to a single file
  - cd packages/@sanity/cli
  - yarn run pack
  - cd $TRAVIS_BUILD_DIR
  - gulp backstopServer &
  - sleep 10
script:

  # Remove source and dependencies from CLI to ensure it works standalone
  - cd $TRAVIS_BUILD_DIR
  - rm -rf packages/@sanity/cli/node_modules
  - rm -rf packages/@sanity/cli/src && rm -rf packages/@sanity/cli/lib

  # Test building the test studio with all customizations
  - cd $TRAVIS_BUILD_DIR/packages/test-studio
  - $TRAVIS_BUILD_DIR/packages/@sanity/cli/bin/sanity build

  # Test initializing a project in unattended mode
  - sanity init -y --project=ppsg7ml5 --dataset=test --output-path=/tmp/test-project

  # Use the newly commited changes instead of the latest dependencies from NPM
  - cd /tmp/test-project
  - $TRAVIS_BUILD_DIR/scripts/symlinkDependencies.js .

  # Test building the project with latest dependencies
  - $TRAVIS_BUILD_DIR/packages/@sanity/cli/bin/sanity build --skip-minify

  # Backstop regression testing
  - cd $TRAVIS_BUILD_DIR
  - node node_modules/backstopjs/cli/index.js test --config=./tests/backstop/config.json
